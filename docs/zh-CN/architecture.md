# EasyMark 架构概述

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Electron 主进程                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 窗口管理     │  │ 插件服务管理 │  │ Python 进程管理      │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
           │                    │                    │
           │ IPC                │ stdio              │ spawn
           ▼                    ▼                    ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   Vue 前端       │  │   推理插件       │  │   训练插件       │
│   (渲染进程)     │  │   (Python)      │  │   (Python)      │
└────────┬────────┘  └─────────────────┘  └─────────────────┘
         │ HTTP/WS
         ▼
┌─────────────────┐
│   Go 后端        │
│   (:18080)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   文件系统       │
│   (SQLite/JSON) │
└─────────────────┘
```

## 技术选型

| 层级 | 技术 | 选型理由 |
|------|------|----------|
| **桌面框架** | Electron | 跨平台、Web 技术栈、成熟生态 |
| **前端** | Vue 3 + TypeScript | 响应式、类型安全、Composition API |
| **UI** | TailwindCSS + shadcn/ui | 现代设计、高度可定制 |
| **后端** | Go | 高性能、单文件部署、并发处理 |
| **数据存储** | SQLite + JSON | 轻量、无需安装、便于备份 |
| **插件** | Python | AI 生态丰富、PyTorch/TensorFlow 支持 |

## 核心模块

### 1. 前端 (frontend/)

```
src/
├── views/              # 页面视图
│   ├── ProjectView     # 标注主界面
│   ├── DatasetView     # 数据集管理
│   ├── TrainingView    # 训练管理
│   └── PluginsView     # 插件管理
├── components/         # 可复用组件
│   ├── AnnotationCanvas # 标注画布（核心）
│   └── ...
├── composables/        # 组合式函数
└── locales/            # 国际化
```

**标注画布** 是核心组件，负责：
- Canvas 渲染与交互
- 矩形框/多边形/关键点绘制
- 缩放、平移、选择操作

### 2. 后端 (backend-go/)

```
backend-go/
├── main.go           # 路由入口
├── project.go        # 项目管理
├── images.go         # 图片管理
├── categories.go     # 类别管理
├── annotations.go    # 标注管理
└── remaining.go      # 其他功能
```

**职责划分：**
- 项目/图片/类别/标注的 CRUD
- 数据集版本管理
- 插件调用与管理
- Python 环境管理
- 训练任务调度

### 3. Electron 主进程 (host-electron/)

```
host-electron/
├── main.ts           # 主进程入口
├── plugin-service.ts # 插件服务管理
└── preload.ts        # 预加载脚本
```

**职责划分：**
- 窗口创建与管理
- 推理插件进程管理（stdio 通信）
- 文件系统访问
- 系统级 API 调用

## 数据流

### 标注流程

```
用户操作 → Canvas 组件 → 前端状态 → HTTP API → Go 后端 → SQLite
```

### 推理流程

```
用户触发 → 前端 → IPC → Electron → Python 进程 → 返回结果 → 渲染到 Canvas
```

### 训练流程

```
用户配置 → HTTP API → Go 后端 → 启动 Python 训练 → WebSocket 推送日志
```

## 数据存储

### 项目数据

```
{DataRoot}/
├── projects/
│   └── {project-id}/
│       ├── images/           # 图片文件
│       └── project.db        # SQLite 数据库
├── datasets/
│   └── {version-id}/         # 数据集版本快照
├── plugins/                  # 已安装插件
├── training/                 # 训练输出
└── models/                   # 推理模型
```

### SQLite 表结构

- `images` - 图片元数据
- `categories` - 类别定义（关键点骨架存储在 `meta` 字段）
- `annotations` - 标注数据

## 插件系统

### 插件类型

| 类型 | 通信方式 | 实现语言 |
|------|----------|----------|
| 数据集插件 | stdin/stdout | Go (编译为 exe) |
| 推理插件 | stdio JSON | Python |
| 训练插件 | stdio + WebSocket | Python |

### 插件生命周期

```
安装 → 加载 manifest → 创建虚拟环境 → 安装依赖 → 就绪
                                              ↓
                                         启动服务 ↔ 调用
                                              ↓
                                           卸载/停止
```

## 设计原则

1. **前后端分离**：前端纯展示逻辑，后端处理数据和文件
2. **插件化扩展**：核心功能内置，AI 能力通过插件扩展
3. **路径可配置**：所有数据路径从设置读取，不硬编码
4. **国际化优先**：所有用户可见文本支持多语言
5. **离线优先**：不依赖云服务，数据本地存储
